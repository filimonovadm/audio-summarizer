# Анализ развертывания бота в Cloud Functions

Этот документ описывает процесс и результаты попытки миграции Telegram-бота на бессерверную архитектуру Google Cloud Functions.

## 1. Цель

Перевести бота с локального запуска (через `polling`) на модель вебхуков, размещенную в Firebase Functions (Google Cloud Functions 2-го поколения), для повышения надежности и масштабируемости.

## 2. Выполненные шаги и решенные проблемы

В процессе развертывания был выполнен ряд шагов по адаптации кода и исправлению множества инфраструктурных проблем:

1.  **Структура проекта:** Код был реорганизован в директорию `functions` в соответствии с требованиями Firebase.
2.  **Переход на вебхуки:** Логика бота была изменена с `polling` на обработку вебхуков.
3.  **Проблема инициализации `telebot`:** Обнаружено, что `pyTelegramBotAPI` вызывает ошибку при инициализации с токеном `None`. Проблема решена путем использования фиктивного токена (`"123:DUMMY_TOKEN"`) при старте с последующей заменой на реальный токен во время выполнения.
4.  **Несовместимость версии Python:** Выявлена и устранена нестабильность при развертывании с `python313`. Среда выполнения была изменена на стабильную версию `python311`.
5.  **Проблемы с виртуальным окружением (`venv`):** Устранены ошибки, связанные с некорректным состоянием `venv` после смены версии Python, путем полного пересоздания окружения и переустановки зависимостей.
6.  **Ошибки файловой системы Cloud Functions:**
    *   **Логирование:** Исправлена ошибка падения контейнера из-за попытки записи логов в файл. Логирование было перенаправлено в стандартный вывод (`stdout`).
    *   **Временные файлы:** Исправлена ошибка падения при обработке аудио из-за попытки сохранения файла в корень проекта. Путь сохранения был изменен на разрешенную временную директорию `/tmp`.
7.  **Проблема "заморозки" функции:** Обнаружено, что асинхронный обработчик `pyTelegramBotAPI` не успевает выполниться. Код был переписан для **синхронной** обработки входящих сообщений.
8.  **Настройка доступа и API:**
    *   **Публичный доступ:** Функции был предоставлен публичный доступ (`roles/run.invoker` для `allUsers`), чтобы она могла принимать запросы от Telegram.
    *   **Включение API:** Были активированы все необходимые API: `Generative Language API` и `Vertex AI API`.
    *   **Права Service Account:** Сервисному аккаунту функции была явно выдана роль `Vertex AI User` для доступа к моделям.

## 3. Финальное препятствие и вывод

Несмотря на решение всех вышеперечисленных проблем, бот по-прежнему не может использовать модели Gemini, получая ошибку:

`404 models/... is not found`

Финальная диагностика с помощью команды `gcloud ai models list --project=stasbaikalbot --region=us-central1` дала окончательный ответ:

**`Listed 0 items.`**

### Заключение

**Код бота и вся процедура развертывания полностью корректны.** Проблема заключается исключительно в конфигурации проекта Google Cloud `stasbaikalbot`. По неизвестным причинам (вероятно, из-за статуса нового проекта, политик организации или биллинга) в указанном регионе для данного проекта **недоступно ни одной AI-модели**.

Дальнейшие действия требуют вмешательства со стороны администратора проекта или обращения в поддержку Google Cloud для выяснения причин отсутствия доступа к моделям Vertex AI / Gemini.
